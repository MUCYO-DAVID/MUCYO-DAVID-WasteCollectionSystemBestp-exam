@page
@model WasteCollectionSystem.Pages.User.RequestWasteModel

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<div class="container py-3">
    <div class="mb-4">
        <h2 class="fw-bold d-flex align-items-center">
            <i class="fa-solid fa-trash-can me-2 text-success"></i>
            Request Waste Collection
        </h2>
        <p class="text-muted">Fill in the details below to schedule a collection.</p>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" asp-antiforgery="true" id="requestForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <!-- Hidden inputs for coordinates -->
                <input type="hidden" asp-for="Input.Latitude" id="latInput" />
                <input type="hidden" asp-for="Input.Longitude" id="lngInput" />
                <input type="hidden" asp-for="Input.LocationName" id="locationNameInput" />

                <div class="mb-3">
                    <label asp-for="Input.Location" class="form-label">Location</label>
                    <div class="input-group mb-2">
                        <textarea class="form-control" id="addressInput" placeholder="e.g., 123 Green St, Block A, near community park" style="height: 80px" asp-for="Input.Location"></textarea>
                    </div>
                    <button type="button" class="btn btn-outline-success btn-sm mb-2" id="toggleMapBtn">
                        <i class="fa-solid fa-map-location-dot me-1"></i> Pick location on map (optional)
                    </button>
                    
                    <!-- Map Container (Hidden by default) -->
                    <div id="mapContainer" class="d-none mb-3 rounded border" style="height: 400px; position: relative;">
                        <div id="map" style="height: 100%; width: 100%; border-radius: var(--border-radius-sm);"></div>
                        
                        <!-- Map Controls Overlay -->
                        <div class="position-absolute top-0 start-0 p-2 w-100" style="z-index: 1000; pointer-events: none;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="bg-white p-2 rounded shadow-sm" style="pointer-events: auto; max-width: 300px;">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="mapSearchInput" placeholder="Search area (e.g. Kacyiru)">
                                        <button class="btn btn-success" type="button" id="mapSearchBtn"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-light btn-sm shadow-sm" id="locateMeBtn" style="pointer-events: auto;">
                                    <i class="fas fa-crosshairs text-primary"></i> Use my location
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <span class="text-danger" asp-validation-for="Input.Location"></span>
                </div>

                <div class="form-floating mb-3">
                    <select class="form-select" asp-for="Input.WasteType">
                        <option value="">Select type...</option>
                        <option>Plastic</option>
                        <option>Organic</option>
                        <option>Paper</option>
                        <option>Metal</option>
                        <option>E-waste</option>
                        <option>Mixed</option>
                    </select>
                    <label asp-for="Input.WasteType">Waste Type</label>
                    <span class="text-danger" asp-validation-for="Input.WasteType"></span>
                </div>

                <div class="form-floating mb-3">
                    <input type="datetime-local" class="form-control" asp-for="Input.PreferredDateTime" />
                    <label asp-for="Input.PreferredDateTime">Preferred Date & Time (optional)</label>
                    <span class="text-danger" asp-validation-for="Input.PreferredDateTime"></span>
                </div>

                <div class="form-floating mb-3">
                    <textarea class="form-control" placeholder="Add helpful notes for the collector" style="height: 100px" asp-for="Input.Notes"></textarea>
                    <label asp-for="Input.Notes">Notes (optional)</label>
                    <span class="text-danger" asp-validation-for="Input.Notes"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="photoInput"><i class="fa-solid fa-camera me-2"></i>Upload photo (optional)</label>
                    <input class="form-control" id="photoInput" type="file" accept="image/*" asp-for="Input.Photo" />
                    <span class="text-danger" asp-validation-for="Input.Photo"></span>
                </div>

                <div class="d-flex gap-2">
                    <button id="submitBtn" type="submit" class="btn btn-success btn-lift">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="btnSpinner" role="status" aria-hidden="true"></span>
                        Submit Request
                    </button>
                    <a class="btn btn-outline-secondary" asp-page="/User/UserDashboard">
                        <i class="fa-solid fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        (function () {
            const form = document.getElementById('requestForm');
            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('btnSpinner');
            
            // Map elements
            const toggleMapBtn = document.getElementById('toggleMapBtn');
            const mapContainer = document.getElementById('mapContainer');
            const addressInput = document.getElementById('addressInput');
            const latInput = document.getElementById('latInput');
            const lngInput = document.getElementById('lngInput');
            const locationNameInput = document.getElementById('locationNameInput');
            const mapSearchInput = document.getElementById('mapSearchInput');
            const mapSearchBtn = document.getElementById('mapSearchBtn');
            const locateMeBtn = document.getElementById('locateMeBtn');
            
            let map = null;
            let marker = null;
            
            // Form submission spinner
            form?.addEventListener('submit', function () {
                spinner.classList.remove('d-none');
                btn.setAttribute('disabled', 'disabled');
            });
            
            // Toggle Map
            toggleMapBtn.addEventListener('click', function() {
                if (mapContainer.classList.contains('d-none')) {
                    mapContainer.classList.remove('d-none');
                    toggleMapBtn.innerHTML = '<i class="fa-solid fa-map-location-dot me-1"></i> Hide map';
                    initMap();
                } else {
                    mapContainer.classList.add('d-none');
                    toggleMapBtn.innerHTML = '<i class="fa-solid fa-map-location-dot me-1"></i> Pick location on map (optional)';
                }
            });
            
            function initMap() {
                if (map) return; // Already initialized
                
                // Default to Kigali center or user's current location if available
                const defaultLat = -1.9441;
                const defaultLng = 30.0619;
                
                map = L.map('map').setView([defaultLat, defaultLng], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Click handler
                map.on('click', function(e) {
                    setMarker(e.latlng.lat, e.latlng.lng);
                    getAddressFromCoords(e.latlng.lat, e.latlng.lng);
                });
                
                // Search handler
                mapSearchBtn.addEventListener('click', searchLocation);
                mapSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchLocation();
                    }
                });
                
                // Locate me handler
                locateMeBtn.addEventListener('click', function() {
                    locateMeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Locating...';
                    
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            map.setView([lat, lng], 16);
                            setMarker(lat, lng);
                            getAddressFromCoords(lat, lng);
                            
                            locateMeBtn.innerHTML = '<i class="fas fa-crosshairs text-primary"></i> Use my location';
                        }, function(error) {
                            console.error("Geolocation error:", error);
                            alert("Could not get your location. Please check your browser settings.");
                            locateMeBtn.innerHTML = '<i class="fas fa-crosshairs text-primary"></i> Use my location';
                        });
                    } else {
                        alert("Geolocation is not supported by this browser.");
                        locateMeBtn.innerHTML = '<i class="fas fa-crosshairs text-primary"></i> Use my location';
                    }
                });
            }
            
            function setMarker(lat, lng) {
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    // Custom green icon
                    const greenIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    marker = L.marker([lat, lng], {icon: greenIcon}).addTo(map);
                }
                
                // Update hidden inputs
                latInput.value = lat;
                lngInput.value = lng;
            }
            
            async function getAddressFromCoords(lat, lng) {
                try {
                    // Using Nominatim (OpenStreetMap) for reverse geocoding
                    // Note: In production, respect usage policy or use a paid service
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const data = await response.json();
                    
                    if (data && data.display_name) {
                        addressInput.value = data.display_name;
                        locationNameInput.value = data.display_name;
                    }
                } catch (error) {
                    console.error("Geocoding error:", error);
                }
            }
            
            async function searchLocation() {
                const query = mapSearchInput.value;
                if (!query) return;
                
                mapSearchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                
                try {
                    // Append 'Rwanda' to context if needed, or keep generic
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        
                        map.setView([lat, lng], 14);
                        setMarker(lat, lng);
                        
                        // If user searched, we can use the search result name or fetch full address
                        addressInput.value = data[0].display_name;
                        locationNameInput.value = data[0].display_name;
                    } else {
                        alert("Location not found. Try a different search term.");
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    alert("Error searching for location.");
                } finally {
                    mapSearchBtn.innerHTML = '<i class="fas fa-search"></i>';
                }
            }
            
        })();
    </script>
}

<style>
    .btn-lift { transition: transform .2s ease, box-shadow .2s ease; }
    .btn-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.08); }
</style>
