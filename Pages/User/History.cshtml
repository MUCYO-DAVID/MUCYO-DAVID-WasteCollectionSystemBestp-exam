@page
@model WasteCollectionSystem.Pages.User.HistoryModel

<div class="container py-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-list-ul text-success me-2"></i>
            <h2 class="fw-bold m-0">History</h2>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-success" asp-page="/User/RequestWaste"><i class="fa-solid fa-plus me-2"></i>Create your first request</a>
            <a class="btn btn-success" asp-page-handler="Export" asp-route-Status="@Model.Status" asp-route-From="@Model.From?.ToString("yyyy-MM-dd")" asp-route-To="@Model.To?.ToString("yyyy-MM-dd")"><i class="fa-solid fa-file-csv me-2"></i>Export CSV</a>
        </div>
    </div>

    <form method="get" class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <div class="form-floating">
                        <select class="form-select" name="Status" value="@Model.Status">
                            <option value="">All statuses</option>
                            <option value="Pending" selected="@(Model.Status=="Pending")">Pending</option>
                            <option value="Assigned" selected="@(Model.Status=="Assigned")">Assigned</option>
                            <option value="In Progress" selected="@(Model.Status=="In Progress")">In Progress</option>
                            <option value="Collected" selected="@(Model.Status=="Collected")">Collected</option>
                            <option value="Completed" selected="@(Model.Status=="Completed")">Completed</option>
                            <option value="Failed" selected="@(Model.Status=="Failed")">Failed</option>
                        </select>
                        <label>Status</label>
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="From" value="@Model.From?.ToString("yyyy-MM-dd")" />
                        <label>From date</label>
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="To" value="@Model.To?.ToString("yyyy-MM-dd")" />
                        <label>To date</label>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-success btn-lift" type="submit"><i class="fa-solid fa-filter me-2"></i>Apply filters</button>
                <a class="btn btn-outline-secondary" href="/User/History"><i class="fa-solid fa-rotate me-2"></i>Reset</a>
            </div>
        </div>
    </form>

    @if (Model.Requests.Count == 0)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <div class="mb-2"><i class="fa-regular fa-face-smile text-success" style="font-size:2rem"></i></div>
                <div class="fw-semibold mb-2">No requests yet</div>
                <p class="text-muted">Start by creating your first waste collection request.</p>
                <a class="btn btn-success btn-lift" asp-page="/User/RequestWaste"><i class="fa-solid fa-plus me-2"></i>Create your first request</a>
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Request ID</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Waste Type</th>
                            <th>Status</th>
                            <th>Assigned Truck</th>
                        </tr>
                    </thead>
                    <tbody>
                    @{
                        var index = 0;
                    }
                    @foreach (var r in Model.Requests)
                    {
                        var detailId = $"detail_{index}";
                        var latestAssignment = r.Assignments.OrderByDescending(a => a.AssignedDate).FirstOrDefault();
                        var truck = latestAssignment?.Truck;
                        var truckLabel = truck != null ? $"{truck.PlateNumber} ({truck.DriverName})" : "";
                        var paymentStatus = r.Payments.Any(p => p.PaymentStatus == "Paid") ? "Paid" : r.Payments.Any() ? "Pending" : "None";
                        <tr class="table-row-expand" data-bs-toggle="collapse" data-bs-target="#@detailId" aria-expanded="false" aria-controls="@detailId" data-request-id="@r.RequestID">
                            <td class="fw-semibold">#@r.RequestID</td>
                            <td>@r.RequestDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>@r.Location</td>
                            <td>@r.WasteType</td>
                            <td><span class="@Model.GetStatusBadgeClass(r.Status) status-cell">@r.Status</span></td>
                            <td>@truckLabel</td>
                        </tr>
                        <tr class="collapse" id="@detailId">
                            <td colspan="6">
                                <div class="row g-3">
                                    <div class="col-12 col-lg-4">
                                        @if (!string.IsNullOrEmpty(r.PhotoPath))
                                        {
                                            <img src="@r.PhotoPath" alt="Photo" class="img-fluid rounded border" />
                                        }
                                        else
                                        {
                                            <div class="text-muted">No photo</div>
                                        }
                                    </div>
                                    <div class="col-12 col-lg-8">
                                        <div class="mb-2"><span class="text-muted">Notes:</span> @r.Notes</div>
                                        <div class="mb-2"><span class="text-muted">Payment:</span> @paymentStatus</div>
                                        <div class="timeline">
                                            <div class="timeline-item">
                                                <div class="timeline-point bg-success"></div>
                                                <div>
                                                    <div class="fw-semibold">Requested</div>
                                                    <div class="text-muted small">@r.RequestDate.ToString("yyyy-MM-dd HH:mm")</div>
                                                </div>
                                            </div>
                                            @if (latestAssignment != null)
                                            {
                                                <div class="timeline-item">
                                                    <div class="timeline-point bg-info"></div>
                                                    <div>
                                                        <div class="fw-semibold">Assigned</div>
                                                        <div class="text-muted small">@latestAssignment.AssignedDate.ToString("yyyy-MM-dd HH:mm")</div>
                                                    </div>
                                                </div>
                                            }
                                            @if (latestAssignment?.CompletionDate != null)
                                            {
                                                <div class="timeline-item">
                                                    <div class="timeline-point bg-success"></div>
                                                    <div>
                                                        <div class="fw-semibold">Collected</div>
                                                        <div class="text-muted small">@latestAssignment.CompletionDate?.ToString("yyyy-MM-dd HH:mm")</div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        index++;
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<style>
    .table-row-expand { cursor: pointer; }
    .timeline { display: grid; gap: .75rem; }
    .timeline-item { display: grid; grid-template-columns: 16px 1fr; gap: .5rem; align-items: start; }
    .timeline-point { width: 12px; height: 12px; border-radius: 50%; margin-top: .35rem; }
    .btn-lift { transition: transform .2s ease, box-shadow .2s ease; }
    .btn-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.08); }
    .bg-orange { background-color: #fd7e14; color: #fff; }
</style>
