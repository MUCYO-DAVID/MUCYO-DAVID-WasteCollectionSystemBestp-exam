@page
@model WasteCollectionSystem.Pages.Admin.RequestsModel
@{
    Layout = "/Pages/Shared/_AdminLayout.cshtml";
}

<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-table text-success me-2"></i>
            <h2 class="fw-bold m-0">All Requests</h2>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-success btn-lift" asp-page-handler="Export" asp-route-Status="@Model.Status" asp-route-Payment="@Model.Payment" asp-route-From="@Model.From?.ToString("yyyy-MM-dd")" asp-route-To="@Model.To?.ToString("yyyy-MM-dd")" asp-route-User="@Model.User" asp-route-Search="@Model.Search"><i class="fa-solid fa-file-excel me-2"></i>Export Excel</a>
        </div>
    </div>

    <form method="get" class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <div class="form-floating">
                        <select class="form-select" name="Status" value="@Model.Status">
                            <option value="">All statuses</option>
                            <option value="Pending" selected="@(Model.Status=="Pending")">Pending</option>
                            <option value="Assigned" selected="@(Model.Status=="Assigned")">Assigned</option>
                            <option value="In Progress" selected="@(Model.Status=="In Progress")">In Progress</option>
                            <option value="Collected" selected="@(Model.Status=="Collected")">Collected</option>
                            <option value="Completed" selected="@(Model.Status=="Completed")">Completed</option>
                            <option value="Failed" selected="@(Model.Status=="Failed")">Failed</option>
                        </select>
                        <label>Status</label>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="form-floating">
                        <select class="form-select" name="Payment" value="@Model.Payment">
                            <option value="">All payments</option>
                            <option value="Paid" selected="@(Model.Payment=="Paid")">Paid</option>
                            <option value="Pending" selected="@(Model.Payment=="Pending")">Pending</option>
                            <option value="None" selected="@(Model.Payment=="None")">None</option>
                        </select>
                        <label>Payment</label>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="From" value="@Model.From?.ToString("yyyy-MM-dd")" />
                        <label>From</label>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="To" value="@Model.To?.ToString("yyyy-MM-dd")" />
                        <label>To</label>
                    </div>
                </div>
                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" name="User" value="@Model.User" placeholder="User" />
                        <label>User</label>
                    </div>
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-12 col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" name="Search" value="@Model.Search" placeholder="Search" />
                        <label>Search</label>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="form-floating">
                        <input type="number" class="form-control" name="PageSize" value="@Model.PageSize" min="5" max="100" />
                        <label>Page Size</label>
                    </div>
                </div>
                <div class="col-6 col-md-3 d-flex align-items-center">
                    <button class="btn btn-success btn-lift me-2" type="submit"><i class="fa-solid fa-filter me-2"></i>Apply</button>
                    <a class="btn btn-outline-secondary" href="/Admin/Requests"><i class="fa-solid fa-rotate me-2"></i>Reset</a>
                </div>
            </div>
        </div>
    </form>

    <form method="post" id="bulkForm">
        <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-success btn-lift" formaction="?handler=BulkApprove" formmethod="post"><i class="fa-solid fa-check me-2"></i>Approve selected</button>
            <button class="btn btn-outline-danger btn-lift" formaction="?handler=BulkDelete" formmethod="post"><i class="fa-solid fa-trash me-2"></i>Delete selected</button>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>ID</th>
                            <th>User</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Waste Type</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items.Count == 0)
                        {
                            <tr><td colspan="10" class="text-center text-muted py-4">No requests found.</td></tr>
                        }
                        else
                        {
                            foreach (var r in Model.Items)
                            {
                                <tr>
                                    <td><input type="checkbox" name="selected" value="@r.RequestID" /></td>
                                    <td class="fw-semibold">#@r.RequestID</td>
                                    <td>@r.UserName</td>
                                    <td>@(r.UserPhone ?? "-")</td>
                                    <td>
                                        @r.Location
                                        @if (r.Latitude.HasValue && r.Longitude.HasValue)
                                        {
                                            <a href="https://www.google.com/maps/search/?api=1&query=@r.Latitude,@r.Longitude" target="_blank" class="text-success ms-1" title="View on Map">
                                                <i class="fa-solid fa-map-location-dot"></i>
                                            </a>
                                        }
                                    </td>
                                    <td>@r.WasteType</td>
                                    <td>@r.RequestDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td><span class="@Model.GetStatusBadgeClass(r.Status)">@r.Status</span></td>
                                    <td>
                                        @if (r.PaymentStatus == "Paid")
                                        {
                                            <span class="badge bg-success">Paid</span>
                                        }
                                        else if (r.PaymentStatus == "Pending")
                                        {
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">None</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <form method="post" asp-page-handler="Approve" class="d-inline">
                                            <input type="hidden" name="id" value="@r.RequestID" />
                                            <button class="btn btn-sm btn-success btn-lift"><i class="fa-solid fa-check me-1"></i>Approve</button>
                                        </form>
                                        <button type="button" class="btn btn-sm btn-outline-success btn-lift ms-2 assignBtn" data-id="@r.RequestID"><i class="fa-solid fa-truck me-1"></i>Assign</button>
                                        <a class="btn btn-sm btn-outline-secondary btn-lift ms-2" asp-page="/Admin/RequestDetails" asp-route-id="@r.RequestID"><i class="fa-solid fa-eye me-1"></i>View</a>
                                        <form method="post" asp-page-handler="Reject" class="d-inline ms-2">
                                            <input type="hidden" name="id" value="@r.RequestID" />
                                            <button class="btn btn-sm btn-outline-danger btn-lift"><i class="fa-solid fa-xmark me-1"></i>Reject</button>
                                        </form>
                                        <form method="post" asp-page-handler="Delete" class="d-inline ms-2" onsubmit="return confirm('Delete this request?')">
                                            <input type="hidden" name="id" value="@r.RequestID" />
                                            <button class="btn btn-sm btn-outline-secondary btn-lift"><i class="fa-solid fa-trash me-1"></i>Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">Total: @Model.TotalCount</div>
            <div class="btn-group">
                @{ var totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize); }
                @for (var p = 1; p <= Math.Max(1, totalPages); p++)
                {
                    var active = p == Model.Page ? "active" : "";
                    <a class="btn btn-outline-secondary @active" href="/Admin/Requests?Page=@p&PageSize=@Model.PageSize&Status=@Model.Status&Payment=@Model.Payment&From=@Model.From?.ToString("yyyy-MM-dd")&To=@Model.To?.ToString("yyyy-MM-dd")&User=@Model.User&Search=@Model.Search">@p</a>
                }
            </div>
        </div>
    </form>

    <div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Assign Truck</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="Assign" id="assignForm">
                        <input type="hidden" name="id" id="assignRequestId" />
                        <div class="form-floating mb-3">
                            <select class="form-select" name="truckId" id="assignTruckId">
                                @foreach (var t in Model.Trucks)
                                {
                                    <option value="@t.TruckID">@t.PlateNumber (@t.DriverName)</option>
                                }
                            </select>
                            <label>Truck</label>
                        </div>
                        <div class="d-flex align-items-center">
                            <button type="submit" class="btn btn-success btn-lift" id="assignSubmit">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="assignSpinner"></span>
                                Assign
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const selectAll = document.getElementById('selectAll');
            selectAll?.addEventListener('change', function () {
                document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = selectAll.checked);
            });

            const assignBtns = document.querySelectorAll('.assignBtn');
            const reqIdInput = document.getElementById('assignRequestId');
            const modalEl = document.getElementById('assignModal');
            const spinner = document.getElementById('assignSpinner');
            const submit = document.getElementById('assignSubmit');
            const bsModal = new bootstrap.Modal(modalEl);
            assignBtns.forEach(b => b.addEventListener('click', function(){ reqIdInput.value = this.getAttribute('data-id'); spinner.classList.add('d-none'); submit.removeAttribute('disabled'); bsModal.show(); }));
            document.getElementById('assignForm')?.addEventListener('submit', function(){ spinner.classList.remove('d-none'); submit.setAttribute('disabled','disabled'); });
        })();
    </script>
}

<style>
    .btn-lift { transition: transform .2s ease, box-shadow .2s ease; }
    .btn-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.08); }
    .bg-orange { background-color: #fd7e14; color: #fff; }
    .fw-bold { letter-spacing: .2px; }
</style>
